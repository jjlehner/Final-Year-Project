# User Guide

V2H is delivered as a library for testbench writers. It provides tools to autogenerate type information from System Verilog modules. This type information and the EDSL utility functions can then be used to write type safe testbenches. The V2H simulation library then provides functions to simulate the system verilog designs driven by testbench stimulus.

## Initiating Auto Generation Of Types for EDSL

To intiate auto-generation of type information from System Verilog design files, simply call the ```setup``` function inside a Template Haskell slice. Due to a limitation in the lens library (see raised issue [https://github.com/ekmett/lens/issues/1032](https://github.com/ekmett/lens/issues/1032)), at the moment an extra splice will have to be called to generate lenses for the autogenerated types. When the patch for this issue is released, the extra splice will no longer be necessary.
```
$(setup "top_level_module_name" [
        "system_verilog_design_file_1.sv",
        "system_verilog_design_file_2.sv",
        "system_verilog_design_file_3.sv"
    ]) -- Invoke V2H to generate type information for EDSL and utility functions

-- Generate lenses for generated types. This extra splice should not be necessary and in future versions of V2H will be removed
$(makeFieldsNoPrefix ''TopLevelModuleName)
```

## What this will bring into scope?

To see what functions and data types the setup splice brings into scope one can use the function setupGenerateFile, which prints all generated constructs into a text file.

```
$(setupWriteOutput "outputfile.txt" top_level_module_name" [
        "system_verilog_design_file_1.sv",
        "system_verilog_design_file_2.sv",
        "system_verilog_design_file_3.sv"
    ]) -- Invoke V2H to generate type information for EDSL and utility functions
```

This helper splice is run with the flipper module, output can be seen in ["flipper_gen.txt"](tests/unit_tests/flipper/rtl/flipper_gen.txt).

In the case of the flipper module the most useful elements it brings into scope are the following:

* The strongly typed representation of the circuit presented to the EDSL.
    ```
    data Flipper = Flipper {
        clk :: (V2H.Simulator.Signal.SignalChange 'FlipperClk (V2H.Simulator.Signal.Signal 1)),
        _d :: (V2H.Simulator.Signal.SignalChange 'FlipperD (V2H.Simulator.Signal.Signal 1))}
    deriving GHC.Show.Show
    ```
* The ```initState``` value which contains the settled initial state of the circuit.

## How to use the EDSL to write testbenches?

### Setting Signal Values

Testbenches written with the V2H EDSL employ monadic do notation. The EDSL operators ```(<==)``` and ```fetchValue``` manipulate the ```State (StimulatedCircuit t)```.

To set a value in a circuit give the lens to the signal and the new value you want to set. See the following example taken from the flipper circuit:

```
let toggleClk = do
            clk <== mkSignal @0
            eval'
            clk <== mkSignal @1
            eval'
```

### Fetching Signal Values

The fetchValue takes a lens to the signal and returns a state monad which hold the signal's value in its result value. Using do notation we can capture the result value as a variable. The following code section shows fetching signal ```d``` from inside the flipper module and setting it to the variable initialDValue.

```
initialDValue <- fetchValue d
```


## Telling the Simulator to Execute

Calling the EDSL function ```eval'`` will invoke the simulator to execuate scheduled signal updates to the circuit.

## Other tools

The symbol visualiser can be used to explore the symbol terminals within System Verilog. Example command usage:

```
cabal run symbol-visualiser -- continuous_assign --avoid=checker_or_generate_item --avoid=non_port_program_item --avoid=interface_or_generate_item --avoid=generate_block --avoid=program_generate_item --avoid=checker_generate_item
```
Generate the symbol hierarchy for continuous assign avoiding certain non-terminals to prune the output tree. See output here [symbol-visualiser/output.png](symbol-visualiser/output.png)
